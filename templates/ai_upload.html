{% extends "base.html" %}

{% block page_title %}âœ¨ AI Prescription Scanner{% endblock %}
{% block page_subtitle %}Upload a prescription image and let our AI instantly extract your medication schedule.{%
endblock %}

{% block content %}
<div class="card" style="max-width: 680px; margin: 0 auto; position: relative;">

    <!-- Upload Zone -->
    <form method="POST" action="{{ url_for('process_prescription') }}" enctype="multipart/form-data" id="uploadForm">

        <label for="fileInput" class="ai-upload-zone" id="dropZone" style="display:block; margin-bottom:32px;">
            <span class="material-icons-round upload-icon">cloud_upload</span>
            <h3 style="color:var(--text); margin-bottom: 12px; font-size:20px;">Drag & Drop your prescription here</h3>
            <p>Or click to browse from your computer</p>
            <p style="font-size:13px; color:var(--text-subtle); margin-top:16px;">Supports PNG, JPG, WEBP (Max 10MB)</p>

            <input type="file" id="fileInput" name="image" accept="image/*" class="hidden" required
                onchange="handleFileSelect(event)" />
        </label>

        <!-- File Preview Area (Hidden by default) -->
        <div id="filePreview"
            style="display:none; align-items:center; gap:16px; padding:16px 20px; background:var(--bg); border:1px solid var(--surface-border); border-radius:var(--radius-sm); margin-bottom:32px;">
            <div
                style="width:48px; height:48px; border-radius:12px; background:var(--primary-light); color:var(--primary); display:flex; align-items:center; justify-content:center;">
                <span class="material-icons-round">image</span>
            </div>
            <div style="flex:1;">
                <div id="fileName" style="font-weight:600; color:var(--text); font-size:15px;">filename.jpg</div>
                <div id="fileSize" style="color:var(--text-muted); font-size:13px;">1.2 MB</div>
            </div>
            <button type="button" class="icon-btn" onclick="clearFile()" aria-label="Remove File">
                <span class="material-icons-round">close</span>
            </button>
        </div>

        <button type="submit" class="btn-primary w-full" id="submitBtn" style="padding:16px; font-size:16px;"
            onclick="document.getElementById('aiSpinner').style.display='inline-block'; this.style.opacity='0.8';">
            <span class="material-icons-round" style="font-size:22px">auto_awesome</span>
            <span style="margin-left:8px">Analyse with AI</span>
            <span class="spinner-sm" id="aiSpinner"
                style="display:none; margin-left:12px; border-color: rgba(255,255,255,0.3); border-top-color:#fff"></span>
        </button>
    </form>
</div>

<script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const filePreview = document.getElementById('filePreview');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');

    // Drag & Drop Handlers
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
            dropZone.style.borderColor = 'var(--primary)';
            dropZone.style.background = 'var(--primary-light)';
        }, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
            dropZone.style.borderColor = 'var(--text-subtle)';
            dropZone.style.background = 'var(--bg)';
        }, false);
    });

    dropZone.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        const files = dt.files;
        if (files.length) {
            fileInput.files = files;
            handleFileSelect({ target: fileInput });
        }
    });

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
            dropZone.style.display = 'none';
            filePreview.style.display = 'flex';
            fileName.textContent = file.name;
            fileSize.textContent = (file.size / (1024 * 1024)).toFixed(2) + ' MB';
        }
    }

    function clearFile() {
        fileInput.value = '';
        filePreview.style.display = 'none';
        dropZone.style.display = 'block';
    }
</script>
{% endblock %}